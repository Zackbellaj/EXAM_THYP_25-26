<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Évaluations - Master</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

<div class="container">
    <h1 class="mb-4 text-primary">Gestion des Notes</h1>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Saisir une nouvelle note</h5>
        </div>
        <div class="card-body">
            <form id="evalForm" onsubmit="event.preventDefault(); setEval();">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">ID de l'Étudiant</label>
                        <input type="number" id="studentId" class="form-control" placeholder="Ex: 15" required>
                        <div class="form-text">L'ID Omeka de l'item "Étudiant" (Resource Class ID 124).</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">ID de l'Évaluation</label>
                        <input type="number" id="evalId" class="form-control" placeholder="Ex: 16" required>
                        <div class="form-text">L'ID Omeka de l'item "Évaluation" (Resource Class ID 126).</div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Note obtenue</label>
                        <input type="number" id="score" class="form-control" step="0.5" min="0" max="20" placeholder="Ex: 14.5" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success w-100">Enregistrer la note</button>
            </form>
        </div>
    </div>

    <hr class="my-5">

    <h3 class="mb-3">Liste des notes enregistrées</h3>
    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-hover table-bordered mb-0">
            <thead class="table-light">
                <tr>
                    <th>ID Note</th>
                    <th>Valeur / 20</th>
                    <th>ID Étudiant (Lien)</th>
                    <th>ID Évaluation (Lien)</th>
                </tr>
            </thead>
            <tbody id="evalTableBody">
                </tbody>
        </table>
    </div>
    <div id="loading" class="text-center py-3">Chargement des données...</div>
</div>

<script>
    // --- 1. CONFIGURATION API ---
    const API_URL = "http://localhost/omeka-s/api/items";
    
    // Clés API (Issues de votre fichier evals.html précédent)
    const KEY_IDENTITY = "Gc6bWQ7GoHSJXMItGy7sEYznwAaAK7ju";
    const KEY_CREDENTIAL = "owhblovm9MzROFdMcmK07DjuZwF4xKSJ";
    
    // --- 2. CONFIGURATION DES IDS (Basée strictement sur bdd.sql) ---
    //
    const CLASS_ID_GRADE = 127;     // Resource Class "Grade"
    const TEMPLATE_ID_NOTE = 19;    // Resource Template "Note"

    const PROP_ID_SCORE = 222;      // Propriété "univ:scoreValue"
    const PROP_ID_STUDENT = 220;    // Propriété "univ:obtainedBy"
    const PROP_ID_EVAL = 221;       // Propriété "univ:forEvaluation"

    // --- FONCTION 1 : ENREGISTRER UNE NOTE (POST) ---
    async function setEval() {
        const studentId = document.getElementById('studentId').value;
        const evalId = document.getElementById('evalId').value;
        const score = document.getElementById('score').value;

        // Construction du payload JSON pour Omeka S
        const data = {
            "o:resource_class": { "o:id": CLASS_ID_GRADE },
            "o:resource_template": { "o:id": TEMPLATE_ID_NOTE }, 
            
            // 1. La valeur de la note (Literal)
            [`property_id:${PROP_ID_SCORE}`]: [ 
                { "type": "literal", "property_id": PROP_ID_SCORE, "@value": score } 
            ],
            // 2. Le lien vers l'étudiant (Resource Item)
            [`property_id:${PROP_ID_STUDENT}`]: [ 
                { "type": "resource:item", "property_id": PROP_ID_STUDENT, "value_resource_id": studentId } 
            ],
            // 3. Le lien vers l'évaluation (Resource Item)
            [`property_id:${PROP_ID_EVAL}`]: [ 
                { "type": "resource:item", "property_id": PROP_ID_EVAL, "value_resource_id": evalId } 
            ]
        };

        try {
            const response = await fetch(`${API_URL}?key_identity=${KEY_IDENTITY}&key_credential=${KEY_CREDENTIAL}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if(response.ok) {
                alert("Succès : La note a été enregistrée !");
                document.getElementById('evalForm').reset(); // Vider le formulaire
                showEval(); // Rafraichir le tableau
            } else {
                const errorData = await response.json();
                console.error("Erreur API:", errorData);
                alert("Erreur lors de l'enregistrement. Vérifiez la console (F12).");
            }
        } catch (e) { 
            console.error("Erreur réseau:", e); 
            alert("Erreur réseau : Impossible de contacter le serveur Omeka S.");
        }
    }

    // --- FONCTION 2 : AFFICHER LES NOTES (GET) ---
    async function showEval() {
        const tbody = document.getElementById('evalTableBody');
        const loading = document.getElementById('loading');
        
        try {
            // On demande uniquement les items de type "Grade" (ID 127)
            const response = await fetch(`${API_URL}?resource_class_id=${CLASS_ID_GRADE}`);
            if (!response.ok) throw new Error("Erreur de récupération des données");

            const evals = await response.json();
            
            tbody.innerHTML = ""; // Vider le tableau
            loading.style.display = 'none'; // Cacher le loader

            if (evals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Aucune note trouvée.</td></tr>';
                return;
            }

            evals.forEach(ev => {
                // Extraction des données.
                // Omeka renvoie les données sous la forme "prefix:localName".
                // D'après votre vocab.ttl et bdd.sql, le préfixe est 'univ'.

                let score = "N/A";
                if(ev['univ:scoreValue']) {
                    score = ev['univ:scoreValue'][0]['@value'];
                }
                
                let studentRef = "Non lié";
                if(ev['univ:obtainedBy']) {
                    const sId = ev['univ:obtainedBy'][0]['value_resource_id'];
                    // Création d'un lien cliquable vers l'API pour vérifier l'étudiant
                    studentRef = `<a href="${API_URL}/${sId}" target="_blank">Étudiant #${sId}</a>`;
                }

                let evalRef = "Non lié";
                if(ev['univ:forEvaluation']) {
                    const eId = ev['univ:forEvaluation'][0]['value_resource_id'];
                    evalRef = `<a href="${API_URL}/${eId}" target="_blank">Évaluation #${eId}</a>`;
                }
                
                let row = `
                    <tr>
                        <td>${ev['o:id']}</td>
                        <td><span class="badge bg-primary fs-6">${score}</span></td>
                        <td>${studentRef}</td>
                        <td>${evalRef}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });

        } catch (e) {
            console.error(e);
            loading.innerHTML = '<span class="text-danger">Erreur de chargement. Vérifiez que Omeka S est lancé.</span>';
        }
    }

    // Charger la liste au démarrage
    document.addEventListener('DOMContentLoaded', showEval);
</script>
</body>
</html>
