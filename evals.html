<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Évaluations</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

<div class="container">
    <h2 class="mb-4 text-primary">Saisir une évaluation</h2>
    
    <div class="card shadow-sm p-4 mb-5 bg-white rounded">
        <form id="evalForm" onsubmit="event.preventDefault(); setEval();">
            <div class="mb-3">
                <label class="form-label fw-bold">ID de l'Étudiant (Omeka ID)</label>
                <input type="number" id="studentId" class="form-control" placeholder="Ex: 12" required>
                <div class="form-text">L'ID technique de l'item "Étudiant" (ex: 12 pour Bellaj Zakariae).</div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">ID du Cours/Éval (Omeka ID)</label>
                <input type="number" id="courseId" class="form-control" placeholder="Ex: 13" required>
                <div class="form-text">L'ID technique de l'item "Cours" (ex: 13 pour Web).</div>
            </div>
            <div class="mb-3">
                <label class="form-label fw-bold">Note (/20)</label>
                <input type="number" id="score" class="form-control" step="0.5" min="0" max="20" placeholder="15" required>
            </div>
            <button type="submit" class="btn btn-success w-100">Enregistrer la note</button>
        </form>
    </div>

    <hr class="my-5">

    <h3 class="mb-3">Liste des notes enregistrées</h3>
    <div class="table-responsive bg-white shadow-sm rounded">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th>ID Note</th>
                    <th>Valeur</th>
                    <th>Étudiant (Lien)</th>
                    <th>Cours (Lien)</th>
                </tr>
            </thead>
            <tbody id="evalTableBody">
                </tbody>
        </table>
    </div>
</div>

<script>
    // --- CONFIGURATION API & IDs (Basée sur votre bdd.sql) ---
    const API_URL = "http://localhost/omeka-s/api/items";
    
    // Vos clés API (à ne pas partager en prod)
    const KEY_IDENTITY = "Gc6bWQ7GoHSJXMItGy7sEYznwAaAK7ju";
    const KEY_CREDENTIAL = "owhblovm9MzROFdMcmK07DjuZwF4xKSJ";
    
    // IDs corrects extraits de votre base de données :
    const CLASS_ID_GRADE = 127;     // Resource Class "Grade"
    const TEMPLATE_ID_NOTE = 19;    // Resource Template "Note" (C'était l'erreur "id:2 non trouvée")

    const PROP_ID_SCORE = 222;      // univ:scoreValue
    const PROP_ID_STUDENT = 220;    // univ:obtainedBy
    const PROP_ID_EVAL = 221;       // univ:forEvaluation

    // 1. Enregistrer une évaluation (POST)
    async function setEval() {
        const studentId = document.getElementById('studentId').value;
        const evalId = document.getElementById('courseId').value;
        const score = document.getElementById('score').value;

        // Construction du JSON selon le format Omeka S
        const data = {
            "o:resource_class": { "o:id": CLASS_ID_GRADE },
            "o:resource_template": { "o:id": TEMPLATE_ID_NOTE },
            
            // Note (Valeur littérale)
            [`property_id:${PROP_ID_SCORE}`]: [ 
                { "type": "literal", "property_id": PROP_ID_SCORE, "@value": score } 
            ],
            // Lien vers l'étudiant (Ressource)
            [`property_id:${PROP_ID_STUDENT}`]: [ 
                { "type": "resource:item", "property_id": PROP_ID_STUDENT, "value_resource_id": studentId } 
            ],
            // Lien vers le cours (Ressource)
            [`property_id:${PROP_ID_EVAL}`]: [ 
                { "type": "resource:item", "property_id": PROP_ID_EVAL, "value_resource_id": evalId } 
            ]
        };

        try {
            const response = await fetch(`${API_URL}?key_identity=${KEY_IDENTITY}&key_credential=${KEY_CREDENTIAL}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if(response.ok) {
                alert("✅ Note enregistrée avec succès !");
                document.getElementById('evalForm').reset();
                showEval(); // Rafraichir le tableau
            } else {
                const errorData = await response.json();
                console.error("Erreur API:", errorData);
                alert("❌ Erreur : " + JSON.stringify(errorData));
            }
        } catch (e) { 
            console.error(e); 
            alert("Erreur réseau. Vérifiez que Omeka S est lancé.");
        }
    }

    // 2. Afficher les évaluations (GET)
    async function showEval() {
        const tbody = document.getElementById('evalTableBody');
        tbody.innerHTML = "<tr><td colspan='4' class='text-center'>Chargement...</td></tr>";

        try {
            // On récupère uniquement les items de type "Grade"
            const response = await fetch(`${API_URL}?resource_class_id=${CLASS_ID_GRADE}`);
            const evals = await response.json();
            
            tbody.innerHTML = "";

            if (evals.length === 0) {
                tbody.innerHTML = "<tr><td colspan='4' class='text-center text-muted'>Aucune note pour le moment.</td></tr>";
                return;
            }

            evals.forEach(ev => {
                // Lecture sécurisée des propriétés
                let score = ev['univ:scoreValue'] ? ev['univ:scoreValue'][0]['@value'] : "-";
                
                let studentId = ev['univ:obtainedBy'] ? ev['univ:obtainedBy'][0]['value_resource_id'] : "N/A";
                let studentLink = studentId !== "N/A" ? `<a href="${API_URL}/${studentId}" target="_blank">Étudiant #${studentId}</a>` : "Non lié";

                let courseId = ev['univ:forEvaluation'] ? ev['univ:forEvaluation'][0]['value_resource_id'] : "N/A";
                let courseLink = courseId !== "N/A" ? `<a href="${API_URL}/${courseId}" target="_blank">Cours #${courseId}</a>` : "Non lié";
                
                let row = `
                    <tr>
                        <td>${ev['o:id']}</td>
                        <td><span class="badge bg-primary fs-6">${score}</span></td>
                        <td>${studentLink}</td>
                        <td>${courseLink}</td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        } catch (e) {
            console.error(e);
            tbody.innerHTML = "<tr><td colspan='4' class='text-danger text-center'>Erreur de chargement des données.</td></tr>";
        }
    }

    // Chargement initial
    document.addEventListener('DOMContentLoaded', showEval);
</script>
</body>
</html>
